<!DOCTYPE html>
<html>
<head>
  <title>WasteKing Dashboard</title>
  <script>
    let lastId = null;

    async function fetchLiveCalls() {
      try {
        const res = await fetch(`/api/dashboard/live_calls?last_id=${lastId || ""}`);
        const data = await res.json();

        if (data.success && data.new_calls.length > 0) {
          data.new_calls.forEach(call => {
            const container = document.getElementById("calls");
            const div = document.createElement("div");
            div.innerHTML = `
              <b>${call.conversation_id}</b> | ${call.timestamp}<br>
              <i>${call.customerquestion || ""}</i>
              <hr>
            `;
            container.prepend(div); // add newest at top
            lastId = call.conversation_id;
          });
        }

        // schedule the next fetch
        setTimeout(fetchLiveCalls, 3000); // every 3s
      } catch (err) {
        console.error("Live fetch error", err);
        setTimeout(fetchLiveCalls, 5000); // retry slower on error
      }
    }

    window.onload = fetchLiveCalls;
  </script>
</head>
<body>
  <h1>WasteKing Dashboard</h1>
  <div id="calls">
    {% for conv_id, calls in grouped_calls.items() %}
      {% for call in calls %}
        <div>
          <b>{{ conv_id }}</b> | {{ call.timestamp }}<br>
          <i>{{ call.customerquestion or '' }}</i>
          <hr>
        </div>
      {% endfor %}
    {% endfor %}
  </div>
</body>
</html>
